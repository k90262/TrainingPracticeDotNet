<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <!--head block內不用對稱-->
    <script src="jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script>
        function openDB(callback) {
            /* open db */
            var reqDB = indexedDB.open("DB123"); // google indexdb -> MDN
            /* check db version and create stores */
            reqDB.onupgradeneeded = function (event) {
                var db = event.target.result;
                if (event.oldVersion < 1) { // google: indexeddb oldversion -> MDN
                    var objectStore = db.createObjectStore("contacts", { keyPath: "name" });
                }

            };
            reqDB.onerror = function (event) {
                alert("Why didn't you allow my web app to use IndexedDB?!");
            };
            /* open db success */
            reqDB.onsuccess = function (event) {
                var db = reqDB.result;
                callback(db);
            };
        }

        function openStore(name, callback){
            openDB(function(db) {
                var transaction = db.transaction(name, "readwrite");
                var objectStore = transaction.objectStore(name);
                callback(objectStore);
            });
        }

        function show() {
            openDB(function (db) {
                var transaction = db.transaction(["contacts"], "readwrite");
                var objectStore = transaction.objectStore("contacts");

                var app = new Vue({
                    el: '#t1',
                    data: {
                        contacts: []
                    }
                });
            });
        }

        $(function () {
            show();

            $("#btnAdd").click(function () {
                var obj = {
                    name: $("#name").val(),
                    phone: $("#phone").val(),
                    age: $("#age").val()
                }
                openStore("contacts", function (objectStore) {
                    var reqAdd = objectStore.add(obj);
                    reqAdd.onsuccess = function (event) {
                        show();
                    };
                    reqAdd.onerror = function (event) {
                        alert("ADD ERROR");
                    };
                });

            });
        });
    </script>
</head>

<body>
    Name: <input type="text" id="name" value="test" /> <br />
    Phone: <input type="text" id="phone" /> <br />
    age: <input type="text" id="age" /> <br />
    <button id="btnAdd">新增聯絡人</button>
    <table border="1" id="t1">
        <tr>
            <th>Name</th>
            <th>Phone</th>
            <th>Age</th>
        </tr>
        <tr v-for="c in contacts">
            <td>{{ c.name }}</td>
            <td>{{ c.phone }}</td>
            <td>{{ c.age }}</td>
        </tr>
    </table>
</body>

</html>